---
phase: 4
plan: 3
name: Handlebars Template & PDF Renderer
wave: 2
depends_on: [04-01]
autonomous: true
---

# Phase 4 Plan 3: Handlebars Template & PDF Renderer

## Objective

Create the Handlebars HTML report template and the Puppeteer-based PDF rendering service. The template receives analysis data, AI-generated content, and branding settings as context and produces a professional, branded PDF report. PDFs are saved to disk under `data/reports/`.

## Context

**Requirements addressed:** REQ-025 (partial — template + PDF rendering)
**Phase goal contribution:** This is the core rendering pipeline — it transforms structured data into the final branded PDF deliverable that gets attached to outreach emails.

## Tasks

### Task 1: Install dependencies

**Files:** `server/package.json`

**Action:**
Install Handlebars and Puppeteer:

```bash
cd server && npm install handlebars puppeteer
```

Puppeteer will download a bundled Chromium. For production/Docker, we may later switch to `puppeteer-core` + system Chrome, but for development the bundled version is fine.

Also install `@types/` if needed (Handlebars ships its own types; Puppeteer ships its own types).

**Verify:**
```bash
cd server && node -e "require('handlebars'); require('puppeteer'); console.log('OK')"
```

**Done when:**
- `handlebars` and `puppeteer` in `server/package.json` dependencies
- Both importable without errors

---

### Task 2: Create the Handlebars report template

**Files:** `server/src/templates/report.hbs`

**Action:**
Create a single-file Handlebars template that renders a complete HTML page (with inline CSS) for the report. The template must be self-contained — all styles inline — because Puppeteer renders it as a standalone HTML page.

**Template structure / sections:**

1. **Cover Page**
   - Company logo (from `branding.logo_url`, fallback to text "Vimsy")
   - Report title: "Website Health Report"
   - Site domain (large)
   - Company name (if known)
   - Date generated
   - Branding color used as accent throughout

2. **Executive Summary** (AI-generated)
   - `{{{ai_executive_summary}}}` — triple-stache for HTML/markdown content
   - Rendered as formatted text with the AI's markdown converted to HTML

3. **Health Score Overview**
   - Large circular/visual score display: `{{health_score}}/100`
   - Priority badge: `{{priority_classification}}`
   - Score breakdown bar chart (CSS-only):
     - Performance: `{{performance_score}}/30`
     - Security: `{{security_score}}/30`
     - SEO: `{{seo_score}}/20`
     - Availability: `{{availability_score}}/20`

4. **Performance Details**
   - PageSpeed Insights scores grid (Performance, Accessibility, SEO, Best Practices)
   - Color-coded (red < 40, orange < 60, yellow < 76, green >= 76)

5. **Security Analysis**
   - SSL status card (valid/invalid, issuer, expiry, protocol)
   - Security headers checklist (present/missing)
   - Vulnerability summary (counts by severity)
   - Top vulnerabilities list (if any)

6. **WordPress Health** (conditional — only if `is_wordpress`)
   - WP version + status
   - Theme info
   - Plugins table (name, version, outdated flag)
   - Exposure warnings (config backups, DB exports, enumerated users)

7. **SEO Overview**
   - SEO score
   - Meta description: present/missing
   - Sitemap: found/not found

8. **Recommendations** (AI-generated)
   - `{{{ai_recommendations}}}` — formatted list of actionable fixes

9. **About Vimsy / CTA** (AI-generated + branding)
   - `{{{ai_pitch}}}` — personalized pitch
   - `{{branding.cta_text}}` — configurable CTA
   - Contact info block: email, phone, website from branding settings

10. **Disclaimer Footer**
    - `{{branding.disclaimer}}` — configurable disclaimer text
    - "Report generated on {{generated_date}} by {{branding.company_name}}"

**Styling guidelines:**
- Use CSS `@page` rules for A4 sizing and margins
- Use `page-break-before: always` for major sections to control pagination
- Primary color from `{{branding.primary_color}}` used for headers, accents, score bars
- Clean, professional typography: system fonts (Arial/Helvetica fallback)
- Score bars rendered as CSS width percentages with colored backgrounds
- Color coding for scores: red (#dc2626), orange (#ea580c), yellow (#ca8a04), green (#16a34a)
- Print-friendly: no shadows, minimal borders, high contrast

**Handlebars helpers needed** (register in renderer):
- `{{#if_eq value compare}}` — equality check
- `{{score_color score}}` — returns CSS color based on score value
- `{{format_date date}}` — format ISO date to readable string
- `{{score_bar score max}}` — returns width percentage
- `{{markdown content}}` — convert markdown to HTML (use a simple regex-based converter or a lightweight lib)

**Verify:**
```bash
# Template file exists and is valid Handlebars
node -e "const hbs = require('handlebars'); const fs = require('fs'); hbs.compile(fs.readFileSync('server/src/templates/report.hbs', 'utf8')); console.log('Template compiles OK')"
```

**Done when:**
- Template file at `server/src/templates/report.hbs`
- All 10 sections present with appropriate Handlebars expressions
- Inline CSS for A4 print layout
- Conditional WordPress section
- Branding placeholders throughout

---

### Task 3: Create the PDF renderer service

**Files:** `server/src/services/report/pdf-renderer.ts`

**Action:**
Create the rendering service that:

1. Compiles the Handlebars template
2. Assembles the template context from site data, analysis data, AI content, and branding settings
3. Renders HTML string
4. Launches Puppeteer, loads the HTML, and generates a PDF
5. Saves the PDF to disk and returns the file path

```typescript
export interface RenderReportInput {
  site: Site;
  analysis: SiteAnalysis;
  aiContent: ReportAIContent;
  branding: Record<string, string>;
}

export interface RenderReportOutput {
  pdfPath: string;       // relative path: reports/vimsy-report-example.com-2026-02-11.pdf
  pdfFilename: string;   // just the filename
}

export async function renderReportPdf(input: RenderReportInput): Promise<RenderReportOutput>
```

Implementation details:

- **Template loading**: Read and compile `report.hbs` once, cache the compiled template in module scope. Re-read on each call in development (check `NODE_ENV`).
- **Template context**: Merge site fields, analysis fields (parse JSON fields like `wpscan_plugins`, `vulnerability_details`), AI content, branding settings, and computed values (score colors, formatted dates).
- **Markdown conversion**: For AI content fields, convert markdown to HTML before passing to template. Use a simple function that handles: `**bold**`, `*italic*`, `- bullet points`, `### headers`, `\n\n` → `<p>` tags. Or install `marked` (lightweight markdown lib).
- **PDF output directory**: `data/reports/` — create if not exists using `fs.mkdirSync(recursive: true)`.
- **Filename convention**: `vimsy-report-{domain}-{YYYY-MM-DD}.pdf` — sanitize domain (replace dots with hyphens for filesystem safety, or keep dots).
- **Puppeteer config**:
  ```typescript
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox'],
  });
  const page = await browser.newPage();
  await page.setContent(html, { waitUntil: 'networkidle0' });
  await page.pdf({
    path: fullPath,
    format: 'A4',
    printBackground: true,
    margin: { top: '20mm', bottom: '20mm', left: '15mm', right: '15mm' },
  });
  await browser.close();
  ```
- **Browser reuse**: For performance, consider launching the browser once and reusing it across renders. Export `initBrowser()` and `closeBrowser()` functions for lifecycle management. The worker can call `initBrowser()` at start and `closeBrowser()` at shutdown.

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- `renderReportPdf()` takes site + analysis + AI content + branding → produces PDF on disk
- Template compiled and cached
- PDF saved to `data/reports/` with correct filename
- Puppeteer launches headless, renders HTML, outputs PDF
- Browser lifecycle managed (init/close)
- Markdown in AI content converted to HTML before template injection

---

## Verification

After all tasks complete:

```bash
# 1. Dependencies installed
cd server && node -e "require('handlebars'); require('puppeteer'); console.log('deps OK')"

# 2. Template compiles
node -e "const hbs = require('handlebars'); const fs = require('fs'); hbs.compile(fs.readFileSync('server/src/templates/report.hbs', 'utf8')); console.log('template OK')"

# 3. TypeScript compiles
cd server && npx tsc --noEmit
```

## Success Criteria

- [ ] Handlebars and Puppeteer installed as dependencies
- [ ] Report template (`report.hbs`) with all 10 sections and inline CSS
- [ ] Template uses branding placeholders (color, logo, company name, CTA, disclaimer)
- [ ] PDF renderer produces A4 PDF from template + data
- [ ] PDFs saved to `data/reports/` directory
- [ ] Markdown in AI content converted to HTML
- [ ] Puppeteer browser lifecycle managed (init/close)
- [ ] TypeScript compiles cleanly

## Output

**Files created:**
- `server/src/templates/report.hbs` — Handlebars HTML report template
- `server/src/services/report/pdf-renderer.ts` — Puppeteer PDF rendering service

**Files modified:**
- `server/package.json` — Add handlebars, puppeteer dependencies
