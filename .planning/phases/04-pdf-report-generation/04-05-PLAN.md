---
phase: 4
plan: 5
name: Reports Page UI
wave: 3
depends_on: [04-01, 04-03, 04-04]
autonomous: true
---

# Phase 4 Plan 5: Reports Page UI

## Objective

Replace the placeholder Reports page with a fully functional UI that lists all sites with completed analysis, shows report generation status, allows manual report generation (single + bulk), provides in-browser PDF viewing and download, and supports report regeneration. Also update the Analysis page to show report generation status alongside analysis status.

## Context

**Requirements addressed:** REQ-025 (partial â€” UI for viewing, downloading, generating reports)
**Phase goal contribution:** Completes the user-facing experience â€” the team can see report status, trigger generation, view reports in-browser, and download PDFs for manual use or review before outreach.

## Tasks

### Task 1: Add report API methods to the client

**Files:** `client/src/lib/api.ts`

**Action:**
Add API methods for all report endpoints:

```typescript
// Reports
getReports: (params?: { status?: string; page?: number; pageSize?: number; sortBy?: string; sortOrder?: string }) => {
  const query = new URLSearchParams();
  if (params?.status) query.set('status', params.status);
  if (params?.page) query.set('page', String(params.page));
  if (params?.pageSize) query.set('pageSize', String(params.pageSize));
  if (params?.sortBy) query.set('sortBy', params.sortBy);
  if (params?.sortOrder) query.set('sortOrder', params.sortOrder);
  return request<any>(`/reports?${query.toString()}`);
},

getReport: (siteId: number) =>
  request<any>(`/reports/${siteId}`),

generateReports: (siteIds: number[]) =>
  request<any>('/reports/generate', {
    method: 'POST',
    body: JSON.stringify({ siteIds }),
  }),

regenerateReport: (siteId: number) =>
  request<any>(`/reports/${siteId}/regenerate`, { method: 'POST' }),

getReportJobs: () =>
  request<any>('/reports/jobs'),
```

For PDF viewing and download, construct URLs directly (not through the `request` helper since they return binary):
```typescript
getReportPdfUrl: (siteId: number) => `${BASE_URL}/reports/${siteId}/pdf`,
getReportDownloadUrl: (siteId: number) => `${BASE_URL}/reports/${siteId}/download`,
```

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- All report API methods added
- PDF URL helpers return direct URLs for browser navigation
- TypeScript compiles

---

### Task 2: Build the Reports page â€” site list with report status

**Files:** `client/src/pages/ReportsPage.tsx`

**Action:**
Replace the placeholder with a full reports page. Structure:

**Header area:**
- Title: "Step 4: PDF Reports"
- Subtitle: "Generate and manage branded analysis reports"
- Action buttons (top-right):
  - "Generate Reports" button (disabled if no sites selected) â€” triggers bulk generation
  - Active job indicator (if report jobs are running, show spinner + "Generating X reports...")

**Filters bar:**
- Report status filter: All / Pending / Generating / Completed / Error / No Report
- Search by domain
- Sort by: domain, health score, report status, generated date

**Sites table:**
Fetch sites that have `analysis_status = 'analyzed'` (or use the reports list endpoint which joins with sites). Columns:

| Column | Content |
|--------|---------|
| Checkbox | For bulk selection |
| Domain | Site domain, clickable |
| Company | `company_name` |
| Health Score | Score badge with color |
| Priority | Priority badge |
| Report Status | Status badge (No Report / Pending / Generating / Completed / Error) |
| Generated | Date if completed |
| Actions | View / Download / Generate / Regenerate buttons |

**Status badges:**
- `No Report` â€” gray
- `Pending` â€” blue with pulse animation
- `Generating` â€” indigo with spinner
- `Completed` â€” green with checkmark
- `Error` â€” red

**Action buttons per row:**
- If no report or error: "Generate" button
- If completed: "View" (opens PDF in new tab), "Download" (triggers download), "Regenerate" button
- If pending/generating: disabled with spinner

**Bulk actions:**
- Select multiple sites via checkboxes
- "Generate Reports" button creates a report job for all selected sites
- "Select All" / "Deselect All" in header checkbox

**Polling:**
- Use `usePolling` hook (or `setInterval`) to refresh the list every 3 seconds when any reports are in `pending` or `generating` status
- Stop polling when all visible reports are `completed` or `error`

**Empty state:**
- If no analyzed sites: "No analyzed sites yet. Run analysis first to generate reports."
- If analyzed sites but no reports: Show the table with "No Report" status and generate buttons

**Verify:**
```bash
cd client && npx tsc --noEmit
# Start dev servers, navigate to /reports
```

**Done when:**
- Reports page shows all analyzed sites with report status
- Filtering by report status works
- Bulk selection and generation works
- Status badges update in real-time via polling
- View opens PDF in new browser tab
- Download triggers file download
- Generate/Regenerate buttons trigger API calls and update status

---

### Task 3: Build the PDF viewer modal

**Files:** `client/src/components/reports/ReportViewer.tsx`

**Action:**
Create a modal component that displays a PDF inline using an `<iframe>` or `<embed>` element:

```typescript
interface ReportViewerProps {
  siteId: number;
  domain: string;
  onClose: () => void;
}
```

Implementation:
- Full-screen modal overlay (same pattern as `AnalysisDetail.tsx`)
- Header with domain name, close button, and download button
- Body: `<iframe src={api.getReportPdfUrl(siteId)} />` filling the modal
- The iframe loads the PDF directly from the API endpoint
- Fallback: if browser can't render PDF inline, show a message with download link
- Download button calls `window.open(api.getReportDownloadUrl(siteId))`

Styling:
- Modal: `fixed inset-0 z-50 bg-black/30` overlay
- Content: `bg-white rounded-xl shadow-xl w-full max-w-5xl h-[85vh] mx-4`
- Header: domain + buttons, border-bottom
- Body: iframe fills remaining height

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Modal opens with PDF rendered inline via iframe
- Download button works
- Close button dismisses modal
- Responsive sizing

---

### Task 4: Update Analysis page to show report status

**Files:** `client/src/pages/AnalysisPage.tsx`

**Action:**
Add a "Report" column to the analysis sites table that shows the report generation status for each site. This gives visibility into report progress without leaving the analysis screen.

Changes:
- Add a "Report" column after the existing "Action" column
- Show report status badge:
  - No report: gray "â€”"
  - Pending: blue "Queued"
  - Generating: indigo spinner "Generating..."
  - Completed: green "Report Ready" (clickable â€” opens PDF in new tab)
  - Error: red "Error" with tooltip showing error message
- The analysis page already fetches site data â€” ensure `report_status` is included in the API response

If the analysis detail endpoint (`/api/analysis/sites`) doesn't return `report_status`, update the backend query to include it (it's on the `sites` table).

**Verify:**
```bash
# Navigate to /analysis, sites with completed analysis should show report status
```

**Done when:**
- Analysis table has a "Report" column
- Report status badges render correctly
- Completed reports are clickable (open PDF)
- Status updates visible without page refresh (existing polling handles this)

---

### Task 5: Add report generation progress to job polling

**Files:** `client/src/pages/ReportsPage.tsx`

**Action:**
Add a job progress indicator at the top of the Reports page when report jobs are running:

- Fetch active report jobs via `api.getReportJobs()`
- If any jobs have status `'running'` or `'pending'`, show a progress banner:
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ“„ Generating reports... 3 of 10 completed   â”‚
  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```
- Progress bar uses `job.processed_items / job.total_items`
- Multiple running jobs: show each with its own progress
- Auto-dismiss when all jobs complete
- Poll job status every 2 seconds while jobs are active

Follow the same progress banner pattern used in the analysis page if one exists, or create a reusable `JobProgressBanner` component in `client/src/components/common/`.

**Verify:**
```bash
# Trigger bulk report generation, observe progress banner
```

**Done when:**
- Progress banner appears when report jobs are running
- Shows processed/total count and percentage bar
- Auto-hides when jobs complete
- Polls at 2-second intervals

---

## Verification

After all tasks complete:

```bash
# 1. Start dev servers
npm run dev

# 2. Navigate to /reports
# - Should see analyzed sites with report status
# - Generate a report for a site
# - Watch status change: pending â†’ generating â†’ completed
# - Click "View" to see PDF in modal
# - Click "Download" to download PDF
# - Click "Regenerate" to re-generate

# 3. Navigate to /analysis
# - Should see "Report" column with status badges

# 4. TypeScript compiles
cd client && npx tsc --noEmit
```

## Success Criteria

- [ ] Reports page lists all analyzed sites with report status
- [ ] Bulk report generation via checkbox selection
- [ ] Status badges update in real-time via polling
- [ ] PDF viewable in-browser via modal with iframe
- [ ] PDF downloadable via direct download
- [ ] Generate and Regenerate buttons functional
- [ ] Progress banner shows during active report jobs
- [ ] Analysis page shows report status column
- [ ] Filter by report status works
- [ ] Empty states handled (no analyzed sites, no reports yet)

## Output

**Files created:**
- `client/src/components/reports/ReportViewer.tsx` â€” PDF viewer modal
- `client/src/components/common/JobProgressBanner.tsx` â€” Reusable job progress banner (optional)

**Files modified:**
- `client/src/pages/ReportsPage.tsx` â€” Full reports page implementation
- `client/src/pages/AnalysisPage.tsx` â€” Add report status column
- `client/src/lib/api.ts` â€” Report API methods
