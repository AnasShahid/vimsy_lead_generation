---
phase: 4
plan: 1
name: Report Data Model & Settings
wave: 1
depends_on: none
autonomous: true
---

# Phase 4 Plan 1: Report Data Model & Settings

## Objective

Create the `site_reports` database table, report-related DB queries, report branding settings (schema + defaults + API), and the Settings UI "Report Branding" tab. This plan establishes the data foundation that all other Phase 4 plans depend on.

## Context

**Requirements addressed:** REQ-025 (partial — data layer + configurable branding)
**Phase goal contribution:** Provides the storage layer for reports and the configurable branding settings that feed into the template and PDF renderer.

## Tasks

### Task 1: Add `site_reports` table to schema.sql

**Files:** `server/src/db/schema.sql`

**Action:**
Add a new `site_reports` table after the `site_analyses` table. Columns:

```sql
CREATE TABLE IF NOT EXISTS site_reports (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  site_id INTEGER NOT NULL REFERENCES sites(id) ON DELETE CASCADE,
  report_job_id TEXT REFERENCES jobs(id),
  status TEXT NOT NULL DEFAULT 'pending',  -- pending, generating, completed, error
  pdf_filename TEXT,                        -- e.g. vimsy-report-example.com-2026-02-11.pdf
  pdf_path TEXT,                            -- relative path under data/reports/
  -- AI-generated content (stored after generation)
  ai_executive_summary TEXT,
  ai_recommendations TEXT,
  ai_pitch TEXT,
  -- Metadata
  health_score INTEGER,                     -- snapshot of score at generation time
  priority_classification TEXT,             -- snapshot
  error TEXT,
  generated_at TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_site_reports_site_id ON site_reports(site_id);
CREATE INDEX IF NOT EXISTS idx_site_reports_job_id ON site_reports(report_job_id);
CREATE INDEX IF NOT EXISTS idx_site_reports_status ON site_reports(status);
```

Also add `report_status` column to the `sites` table:
```sql
ALTER TABLE sites ADD COLUMN report_status TEXT;
```
Handle this in the DB init code (migration-style, check if column exists before adding).

**Verify:**
```bash
# Server starts without DB errors
cd server && npx tsx src/index.ts
```

**Done when:**
- `site_reports` table created on server start
- `report_status` column exists on `sites` table
- No schema errors on fresh or existing database

---

### Task 2: Create report DB queries module

**Files:** `server/src/db/queries/reports.ts`

**Action:**
Create a new query module following the pattern of `analyses.ts`. Functions needed:

- `createReport(siteId: number, jobId: string): SiteReport` — Insert pending report row
- `getReportById(id: number): SiteReport | null`
- `getReportBySiteId(siteId: number): SiteReport | null` — Latest report for a site
- `getReportsByJobId(jobId: string): SiteReport[]`
- `updateReport(id: number, data: Partial<SiteReport>): void` — Update status, AI content, pdf path, etc.
- `listReports(filters: ReportListFilters): { reports: SiteReport[]; total: number }` — Paginated list with status/priority filters, joined with site domain/company_name
- `deleteReport(id: number): void`

Define `SiteReport` interface matching the table columns. Define `ReportListFilters` interface with `status?`, `page?`, `pageSize?`, `sortBy?`, `sortOrder?`.

The `listReports` query should JOIN with `sites` to include `domain`, `company_name`, `industry_segment` in results.

Follow the `normalizeAnalysisRow` pattern for boolean conversions if needed.

**Verify:**
```bash
# TypeScript compiles without errors
cd server && npx tsc --noEmit
```

**Done when:**
- All CRUD functions exported from `reports.ts`
- `SiteReport` and `ReportListFilters` interfaces defined
- TypeScript compiles cleanly

---

### Task 3: Add report branding settings defaults and API

**Files:** `server/src/db/queries/settings.ts`, `server/src/routes/settings.ts`

**Action:**

In `settings.ts`, add default constants:
```typescript
export const DEFAULT_REPORT_SETTINGS = {
  report_company_name: 'Vimsy',
  report_logo_url: '',
  report_primary_color: '#4F46E5',
  report_disclaimer: 'This report is generated automatically based on publicly available data...',
  report_cta_text: 'Ready to improve your website? Contact Vimsy for a free consultation.',
  report_contact_email: '',
  report_contact_phone: '',
  report_contact_website: 'https://vimsy.com',
};
```

Add helper functions:
- `getReportSettings(): Record<string, string>` — Returns all `report_*` settings with defaults
- `setReportSettings(settings: Record<string, string>): void` — Bulk-set report settings

In `settings.ts` routes, update the `GET /api/settings` endpoint to also return report settings in the response data object.

Add new endpoints:
- `GET /api/settings/report` — Get report branding settings
- `PUT /api/settings/report` — Update report branding settings (accepts partial object)

In the `PUT /api/settings` handler, also accept report settings fields and save them.

**Verify:**
```bash
curl http://localhost:3001/api/settings/report
# Should return default report settings
```

**Done when:**
- `GET /api/settings` includes report branding fields
- `GET /api/settings/report` returns report-specific settings with defaults
- `PUT /api/settings/report` persists changes to DB
- All settings have sensible defaults

---

### Task 4: Add "Report Branding" tab to Settings UI

**Files:** `client/src/pages/SettingsPage.tsx`

**Action:**

Add a third tab to the `TABS` array:
```typescript
{ key: 'report', label: 'Report Branding', icon: <FileText size={18} />, description: 'PDF report branding & content' }
```

Update `SettingsTab` type to include `'report'`.

Add state for report settings: `reportSettings` object, `reportSaving`, `reportSaved`.

Load report settings in the existing `useEffect` alongside other settings (call `api.getReportSettings()`).

Build the "Report Branding" tab panel with form fields:
- **Company Name** — text input (default: "Vimsy")
- **Logo URL** — text input with preview (show image if URL is valid)
- **Primary Brand Color** — color picker input (`type="color"`) + hex text input
- **Disclaimer Text** — textarea (3-4 rows)
- **CTA Text** — textarea (2-3 rows)
- **Contact Email** — text input
- **Contact Phone** — text input
- **Contact Website** — text input

Add a Save button that calls `api.updateReportSettings(reportSettings)`.

Follow the existing tab panel styling pattern (white card with header, form fields with labels, save button).

Add API methods to `client/src/lib/api.ts`:
- `getReportSettings: () => request<any>('/settings/report')`
- `updateReportSettings: (body: Record<string, string>) => request<any>('/settings/report', { method: 'PUT', body: JSON.stringify(body) })`

**Verify:**
```bash
# Start dev servers and navigate to /settings
# Click "Report Branding" tab
# Fill in fields, click Save, refresh — values persist
```

**Done when:**
- Settings page has 3 tabs: AI Analysis, Security Database, Report Branding
- Report branding fields render with defaults
- Save persists values, page reload shows saved values
- Logo URL shows image preview when valid

---

### Task 5: Add SiteReport type to shared types

**Files:** `shared/types.ts`

**Action:**

Add the `SiteReport` interface and related types:

```typescript
export type ReportStatus = 'pending' | 'generating' | 'completed' | 'error';

export interface SiteReport {
  id: number;
  site_id: number;
  report_job_id: string | null;
  status: ReportStatus;
  pdf_filename: string | null;
  pdf_path: string | null;
  ai_executive_summary: string | null;
  ai_recommendations: string | null;
  ai_pitch: string | null;
  health_score: number | null;
  priority_classification: string | null;
  error: string | null;
  generated_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface ReportJobConfig {
  siteIds: number[];
}
```

Add `report_status` to the `Site` interface:
```typescript
report_status: ReportStatus | null;
```

**Verify:**
```bash
cd shared && npx tsc --noEmit
cd server && npx tsc --noEmit
cd client && npx tsc --noEmit
```

**Done when:**
- `SiteReport`, `ReportStatus`, `ReportJobConfig` exported from shared types
- `Site` interface includes `report_status`
- All workspaces compile cleanly

---

## Verification

After all tasks complete:

```bash
# 1. Server starts without errors
cd server && npx tsx src/index.ts &
sleep 2

# 2. Report settings API works
curl -s http://localhost:3001/api/settings/report | jq .

# 3. TypeScript compiles
cd server && npx tsc --noEmit
cd client && npx tsc --noEmit

# 4. Kill server
kill %1
```

## Success Criteria

- [ ] `site_reports` table exists in schema with all columns
- [ ] `report_status` column added to `sites` table
- [ ] Report CRUD queries module (`reports.ts`) with all functions
- [ ] Report branding settings with defaults stored in `settings` table
- [ ] Settings API endpoints for report branding (GET + PUT)
- [ ] Settings UI has "Report Branding" tab with all fields
- [ ] `SiteReport` type in shared types
- [ ] All workspaces compile without errors

## Output

**Files created:**
- `server/src/db/queries/reports.ts` — Report CRUD queries

**Files modified:**
- `server/src/db/schema.sql` — Add `site_reports` table
- `server/src/db/index.ts` — Migration for `report_status` column on sites
- `server/src/db/queries/settings.ts` — Report branding defaults and helpers
- `server/src/routes/settings.ts` — Report settings API endpoints
- `client/src/pages/SettingsPage.tsx` — Report Branding tab
- `client/src/lib/api.ts` — Report settings API methods
- `shared/types.ts` — SiteReport type, ReportStatus, ReportJobConfig
