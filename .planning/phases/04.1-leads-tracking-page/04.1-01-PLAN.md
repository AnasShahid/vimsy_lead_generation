---
phase: 4.1
plan: 1
name: Leads API & Backend Query
wave: 1
depends_on: none
autonomous: true
---

# Phase 4.1 Plan 1: Leads API & Backend Query

## Objective

Create a dedicated `/api/leads` backend route that returns all post-discovery sites (pipeline_stage != 'discovered') with joined contact counts, latest analysis summary, latest report status, and tags — in a single paginated, filterable endpoint. This powers the unified Leads tracking page.

## Context

**Requirements addressed:** REQ-031, REQ-033, REQ-034
**Phase goal contribution:** Provides the data layer for the unified Leads page. Without this endpoint, the frontend would need to call enrichment, analysis, and report APIs separately and merge client-side.

## Tasks

### Task 1: Create leads query function

**Files:** `server/src/db/queries/leads.ts`

**Action:**
Create a new query module `leads.ts` with a `listLeads()` function that:

1. Selects from `sites` WHERE `pipeline_stage != 'discovered'` (i.e., any site that has entered enrichment or beyond)
2. LEFT JOINs a subquery on `contacts` to get `contact_count` per site
3. LEFT JOINs a subquery on `site_analyses` (latest per site_id, ordered by created_at DESC) to get: `health_score`, `priority_classification`, `action_status`, `analyzed_at`
4. LEFT JOINs a subquery on `site_reports` (latest per site_id, ordered by created_at DESC) to get: `report_status` (from report table), `pdf_filename`, `generated_at`
5. Supports these filter parameters:
   - `search` — matches domain, company_name, url
   - `enrichment_status` — exact match on sites.enrichment_status
   - `analysis_status` — exact match on sites.analysis_status
   - `report_status` — exact match on sites.report_status
   - `outreach_status` — exact match on sites.outreach_status
   - `priority` — exact match on sites.priority (hot/warm/cold)
   - `priority_classification` — exact match on analysis priority_classification (critical/high/medium/low)
   - `tag` — filter by tag from site_tags table (JOIN)
   - `country` — exact match
6. Supports pagination (`page`, `pageSize`) and sorting (`sortBy`, `sortOrder`)
7. Allowed sort columns: `domain`, `company_name`, `updated_at`, `created_at`, `health_score`, `priority`, `enrichment_status`, `analysis_status`, `report_status`
8. Returns `{ leads: LeadRow[], total: number }` where `LeadRow` extends Site with `contact_count`, `analysis` summary object, `report` summary object, and `tags` array

Define a `LeadRow` interface in this file (not in shared types yet — keep it local to avoid touching shared until needed).

Follow the exact same patterns used in `sites.ts` `listSites()` for WHERE clause building, parameterized queries, safe sort columns, and pagination.

**Verify:**
```bash
cd server && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- `listLeads()` compiles without errors
- Function accepts all filter params listed above
- Returns joined data from sites + contacts count + analysis summary + report summary

---

### Task 2: Create leads routes

**Files:** `server/src/routes/leads.ts`, `server/src/app.ts`

**Action:**
Create `server/src/routes/leads.ts` with these endpoints:

1. **GET /api/leads** — List leads with filters
   - Query params: `page`, `pageSize`, `search`, `enrichment_status`, `analysis_status`, `report_status`, `outreach_status`, `priority`, `priority_classification`, `tag`, `country`, `sortBy`, `sortOrder`
   - Calls `listLeads()` from Task 1
   - Returns `{ success: true, data: leads, total, page, pageSize }`

2. **GET /api/leads/:id** — Get single lead detail
   - Returns the site with ALL contacts (full contact objects, not just count), full analysis record, full report record, and tags
   - Uses existing `getSiteById`, `getContactsBySiteId`, `getAnalysisBySiteId`, `getReportBySiteId`, `getTagsForSites`

3. **GET /api/leads/stats** — Get aggregate counts for filter tabs
   - Returns counts grouped by: enrichment_status, analysis_status, report_status, outreach_status, priority
   - Single query with CASE/SUM for efficiency
   - Only counts sites where `pipeline_stage != 'discovered'`

Mount in `app.ts`:
```typescript
import { leadsRoutes } from './routes/leads';
app.use('/api/leads', leadsRoutes);
```

Place the mount AFTER the existing report routes line.

Follow the exact same Express Router pattern used in `enrichment.ts` and `analysis.ts`.

**Verify:**
```bash
cd server && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- All 3 endpoints compile
- GET /api/leads returns paginated leads with joined data
- GET /api/leads/:id returns full detail with contacts array
- GET /api/leads/stats returns aggregate counts
- Route is mounted in app.ts

---

### Task 3: Add leads API methods to client

**Files:** `client/src/lib/api.ts`

**Action:**
Add these methods to the `api` object in `client/src/lib/api.ts`:

```typescript
// Leads
getLeads: (params: Record<string, string | number | boolean | undefined> = {}) => {
  const query = Object.entries(params)
    .filter(([, v]) => v !== undefined && v !== '')
    .map(([k, v]) => `${k}=${encodeURIComponent(String(v))}`)
    .join('&');
  return request<any>(`/leads${query ? `?${query}` : ''}`);
},

getLeadDetail: (id: number) =>
  request<any>(`/leads/${id}`),

getLeadStats: () =>
  request<any>('/leads/stats'),
```

Place these after the existing Reports section, before the closing `};`.

**Verify:**
```bash
cd client && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- Three new API methods added
- TypeScript compiles without errors

---

## Verification

After all tasks complete:

```bash
# Server compiles
cd server && npx tsc --noEmit

# Client compiles
cd client && npx tsc --noEmit

# Start server and test endpoint
cd server && npx tsx src/index.ts &
sleep 2
curl -s http://localhost:3001/api/leads?pageSize=5 | head -c 500
curl -s http://localhost:3001/api/leads/stats | head -c 500
kill %1
```

## Success Criteria

- [ ] `listLeads()` query returns sites with contact_count, analysis summary, report summary, tags
- [ ] GET /api/leads supports all 9 filter params + pagination + sorting
- [ ] GET /api/leads/:id returns full detail with contacts array
- [ ] GET /api/leads/stats returns aggregate counts for filter tabs
- [ ] Client api.ts has getLeads, getLeadDetail, getLeadStats methods
- [ ] Both server and client compile without TypeScript errors

## Output

**Files created:**
- `server/src/db/queries/leads.ts` — Lead list query with joins and filters
- `server/src/routes/leads.ts` — Express routes for leads API

**Files modified:**
- `server/src/app.ts` — Mount leads routes
- `client/src/lib/api.ts` — Add leads API methods
