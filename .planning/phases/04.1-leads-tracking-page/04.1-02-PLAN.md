---
phase: 4.1
plan: 2
name: Leads Tracking Page UI
wave: 2
depends_on: ["04.1-01"]
autonomous: true
---

# Phase 4.1 Plan 2: Leads Tracking Page UI

## Objective

Build the unified Leads tracking page that shows every post-discovery site in one table with combined enrichment, analysis, report, and outreach status columns. Includes expandable detail rows, multi-column filtering, "select all by filter" bulk actions, and the ability to trigger analysis/reports directly from this page.

## Context

**Requirements addressed:** REQ-031, REQ-032, REQ-033, REQ-034, REQ-035
**Phase goal contribution:** This is the primary deliverable of Phase 4.1 — the central tracking hub that replaces navigating between enrichment/analysis/reports tabs to track lead progress.

## Tasks

### Task 1: Create LeadsPage component with table and filters

**Files:** `client/src/pages/LeadsPage.tsx`

**Action:**
Create a new page component `LeadsPage` following the same patterns as `ReportsPage.tsx` and `AnalysisPage.tsx`. The page should include:

**Header:** "Leads" with subtitle "Track all leads through the pipeline"

**Stats bar (top):** A row of small stat cards showing counts from `api.getLeadStats()`:
- Total leads
- Enriched count
- Analyzed count
- Reports ready count
- Outreach sent count

**Filter tabs:** Horizontal pill-style tabs (same pattern as ReportsPage filter tabs) for quick filtering:
- All | Enriched | Analyzed | Reported | Outreach Pending
- These map to combinations of enrichment_status/analysis_status/report_status

**Multi-column filter row:** Below the tabs, a row of dropdown selects for granular filtering:
- Enrichment Status dropdown (all, pending, enriching, enriched, error)
- Analysis Status dropdown (all, pending, analyzing, analyzed, error)
- Report Status dropdown (all, pending, generating, completed, error)
- Outreach Status dropdown (all, not_started, in_progress, done)
- Priority dropdown (all, hot, warm, cold)
- Search input (domain/company name)

**Actions bar:**
- "Analyze Selected" button — calls `api.createAnalysisJob(selectedIds)` for selected leads
- "Generate Reports" button — calls `api.generateReports(selectedIds)` for selected leads
- "Refresh" button
- Selected count indicator

**Data table columns:**
1. Checkbox (select)
2. Domain (link to site URL, external)
3. Company (company_name or "—")
4. Contacts (contact_count number, or "—" if 0)
5. Enrichment (status badge: pending/enriching/enriched/error/—)
6. Analysis (status badge + health score if analyzed)
7. Report (status badge: pending/generating/completed/error/—)
8. Outreach (status badge: not_started/in_progress/done)
9. Priority (hot/warm/cold badge)
10. Actions (expand button to toggle detail row)

**Select all by filter:** The header checkbox selects/deselects ALL currently filtered leads (not just current page if paginated). Use the same `Set<number>` pattern as ReportsPage.

**Pagination:** Bottom of table with page controls. Use `page` and `pageSize` params to `api.getLeads()`.

**Polling:** Use `usePolling` hook (same as ReportsPage) to auto-refresh every 5 seconds when there are active jobs (any lead with pending/enriching/analyzing/generating status).

**State management:**
- `leads` array from API
- `stats` object from API
- `filters` object for all dropdown values
- `selectedIds` Set
- `expandedId` for which row is expanded (null or site id)
- `loading` boolean
- `error` string | null

Use `useCallback` for fetch functions and `useEffect` for initial load, same pattern as ReportsPage.

**Verify:**
```bash
cd client && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- LeadsPage renders with header, stats bar, filter tabs, filter dropdowns, table, pagination
- Table shows all 10 columns with appropriate badges
- Checkbox selection works with "select all by filter"
- Bulk action buttons call correct API methods
- Polling refreshes when active jobs detected

---

### Task 2: Create expandable lead detail panel

**Files:** `client/src/components/leads/LeadDetailPanel.tsx`

**Action:**
Create an expandable detail component that renders inline below a lead row when the expand button is clicked. It receives a `siteId` prop and fetches full detail via `api.getLeadDetail(siteId)`.

**Layout:** A card-style panel with 3 columns:

**Column 1 — Contacts:**
- List all contacts for this lead
- Each contact shows: name, email (mailto link), position, seniority, department, confidence score, verification status badge
- If no contacts: "No contacts found" message

**Column 2 — Analysis Summary:**
- Health score (large number with color)
- Priority classification badge
- Sub-scores: Performance, Security, SEO, Availability (small progress bars or numbers)
- Vulnerabilities found count
- Analyzed date
- If no analysis: "Not analyzed yet" with "Analyze" button that calls `api.createAnalysisJob([siteId])`

**Column 3 — Report & Actions:**
- Report status badge
- If report completed: "View PDF" button (opens modal or new tab via `api.getReportPdfUrl(siteId)`), "Download" link
- If no report but analyzed: "Generate Report" button
- Action history: show pipeline_stage, enrichment_status, analysis_status, report_status, outreach_status as a mini timeline/progress indicator
- Tags list (from tags array)

**Loading state:** Show skeleton/spinner while `api.getLeadDetail()` is loading.

Follow the same component patterns as `ContactDetailsPanel.tsx` and `AnalysisDetail.tsx` for styling.

**Verify:**
```bash
cd client && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- Panel renders contacts, analysis summary, and report/actions in 3 columns
- Fetches full detail on mount via API
- Action buttons (Analyze, Generate Report, View PDF, Download) work
- Loading state shown while fetching

---

### Task 3: Wire up routing, navigation, and integrate detail panel

**Files:** `client/src/App.tsx`, `client/src/components/layout/Sidebar.tsx`, `client/src/pages/LeadsPage.tsx`

**Action:**

1. **App.tsx** — Add route for LeadsPage:
   ```tsx
   import { LeadsPage } from './pages/LeadsPage';
   // Add inside <Route element={<Layout />}>:
   <Route path="/leads" element={<LeadsPage />} />
   ```

2. **Sidebar.tsx** — Add Leads nav item. Insert it between "4. Reports" and "5. Outreach":
   ```tsx
   { to: '/leads', label: 'Leads', icon: Target },
   ```
   Import `Target` from lucide-react (represents a lead/target). This replaces the current "6. Tracking" label conceptually — the Leads page IS the tracking hub. Keep the existing Tracking item for now (Phase 6 will repurpose it as the metrics dashboard).

3. **LeadsPage.tsx** — Import and render `LeadDetailPanel` inside the table. When `expandedId === site.id`, render a `<tr>` with `<td colSpan={10}>` containing the `<LeadDetailPanel siteId={site.id} />` component directly below that row.

4. **LeadsPage.tsx** — Wire up the bulk action buttons:
   - "Analyze Selected" → `api.createAnalysisJob(Array.from(selectedIds))` then refresh
   - "Generate Reports" → `api.generateReports(Array.from(selectedIds))` then refresh
   - Both should show loading state on the button and clear selection after success

**Verify:**
```bash
cd client && npx tsc --noEmit 2>&1 | head -20
```

**Done when:**
- `/leads` route works and shows LeadsPage
- Sidebar has "Leads" nav item between Reports and Outreach
- Clicking expand on a row shows LeadDetailPanel inline
- Bulk actions trigger correct API calls and refresh data
- Full page compiles and renders without errors

---

## Verification

After all tasks complete:

```bash
# Both compile
cd server && npx tsc --noEmit
cd client && npx tsc --noEmit

# Start both and verify page loads
cd server && npx tsx src/index.ts &
cd client && npx vite --port 5173 &
sleep 3

# Check API works
curl -s http://localhost:3001/api/leads?pageSize=3 | python3 -m json.tool | head -30
curl -s http://localhost:3001/api/leads/stats | python3 -m json.tool

# Manual: Open http://localhost:5173/leads and verify:
# - Stats bar shows counts
# - Table renders with all columns
# - Filters work
# - Expand row shows detail panel
# - Bulk actions work

kill %1 %2
```

## Success Criteria

- [ ] LeadsPage shows all post-discovery sites in a unified table
- [ ] Each lead row displays: domain, company, contacts count, enrichment status, analysis status, report status, outreach status, priority
- [ ] Expandable detail view shows all contacts, analysis scores, report actions, and tags
- [ ] Multi-column filtering works (enrichment, analysis, report, outreach status + priority + search)
- [ ] "Select all by filter" selects all visible filtered leads
- [ ] Bulk "Analyze" and "Generate Reports" actions work from Leads page
- [ ] Sidebar navigation includes Leads item
- [ ] Route /leads renders the page correctly
- [ ] Polling auto-refreshes when active jobs are detected

## Output

**Files created:**
- `client/src/pages/LeadsPage.tsx` — Main Leads tracking page
- `client/src/components/leads/LeadDetailPanel.tsx` — Expandable detail panel

**Files modified:**
- `client/src/App.tsx` — Add /leads route
- `client/src/components/layout/Sidebar.tsx` — Add Leads nav item
