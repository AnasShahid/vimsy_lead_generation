---
phase: 3
plan: 1
name: Analysis Infrastructure & Schema
wave: 1
depends_on: none
autonomous: true
---

# Phase 3 Plan 1: Analysis Infrastructure & Schema

## Objective

Set up the foundational infrastructure for technical analysis: database schema for storing analysis results, WPScan Docker container, local vulnerability database, analysis worker with parallel processing, API routes, tags system, and the "move to analysis" flow from enrichment.

## Context

**Requirements addressed:** REQ-018 (partial — infrastructure for health scoring)
**Phase goal contribution:** Provides the skeleton that Plan 2 (services) and Plan 3 (UI) build on. Without this, no analysis can run.

## Tasks

### Task 1: Database Schema — Analysis Tables & Tags

**Files:** `server/src/db/schema.sql`, `server/src/db/migrations.ts`, `shared/types.ts`

**Action:**

1. Add `site_analyses` table to `schema.sql`:
   ```sql
   CREATE TABLE IF NOT EXISTS site_analyses (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     site_id INTEGER NOT NULL REFERENCES sites(id) ON DELETE CASCADE,
     analysis_job_id TEXT REFERENCES jobs(id),
     status TEXT NOT NULL DEFAULT 'pending',
     -- Composite score
     health_score INTEGER,
     priority_classification TEXT,
     -- Performance (PSI)
     psi_performance_score REAL,
     psi_accessibility_score REAL,
     psi_seo_score REAL,
     psi_best_practices_score REAL,
     psi_raw_data TEXT,
     -- SSL/TLS
     ssl_valid INTEGER,
     ssl_issuer TEXT,
     ssl_expiry_date TEXT,
     ssl_days_until_expiry INTEGER,
     ssl_protocol_version TEXT,
     ssl_cipher TEXT,
     ssl_chain_valid INTEGER,
     ssl_raw_data TEXT,
     -- WordPress (WPScan)
     wpscan_wp_version TEXT,
     wpscan_wp_version_status TEXT,
     wpscan_theme TEXT,
     wpscan_theme_version TEXT,
     wpscan_plugins TEXT,
     wpscan_users TEXT,
     wpscan_config_backups TEXT,
     wpscan_db_exports TEXT,
     wpscan_raw_data TEXT,
     -- Vulnerability matching
     vulnerabilities_found INTEGER DEFAULT 0,
     vulnerability_details TEXT,
     -- Sub-scores
     security_score REAL,
     performance_score REAL,
     wp_health_score REAL,
     -- Timestamps
     analyzed_at TEXT,
     created_at TEXT DEFAULT (datetime('now')),
     updated_at TEXT DEFAULT (datetime('now')),
     UNIQUE(site_id, analysis_job_id)
   );
   ```

2. Add `site_tags` table:
   ```sql
   CREATE TABLE IF NOT EXISTS site_tags (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     site_id INTEGER NOT NULL REFERENCES sites(id) ON DELETE CASCADE,
     tag TEXT NOT NULL,
     assigned_at TEXT DEFAULT (datetime('now')),
     UNIQUE(site_id, tag)
   );
   ```

3. Add `wp_vulnerabilities` table for local vulnerability DB cache:
   ```sql
   CREATE TABLE IF NOT EXISTS wp_vulnerabilities (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     title TEXT,
     cve_id TEXT,
     cvss_score REAL,
     cvss_rating TEXT,
     software_name TEXT,
     software_type TEXT,
     software_slug TEXT,
     affected_versions TEXT,
     patched_status TEXT,
     remediation TEXT,
     description TEXT,
     published_date TEXT,
     last_updated_date TEXT,
     imported_at TEXT DEFAULT (datetime('now'))
   );
   ```

4. Add indexes for new tables.

5. Add `analysis_status` column to `sites` table (like `enrichment_status`).

6. Update `migrations.ts` to create these tables and add the `analysis_status` column for existing DBs.

7. Update `shared/types.ts`:
   - Add `AnalysisStatus` type: `'pending' | 'analyzing' | 'analyzed' | 'error'`
   - Add `AnalysisPriority` type: `'critical' | 'high' | 'medium' | 'low'`
   - Add `SiteAnalysis` interface matching the table
   - Add `SiteTag` interface
   - Add `WpVulnerability` interface
   - Add `AnalysisJobConfig` interface: `{ siteIds: number[] }`
   - Update `Site` interface to include `analysis_status`
   - Update `PipelineStage` to include `'analysis'`
   - Update `batchUpdateSites` allowedFields to include `analysis_status`

**Verify:**
```bash
cd server && npx tsx -e "
  const { getDb } = require('./src/db');
  const db = getDb();
  const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all();
  console.log(tables.map(t => t.name));
"
```

**Done when:**
- `site_analyses`, `site_tags`, `wp_vulnerabilities` tables exist in schema
- `analysis_status` column on `sites` table
- All types exported from `shared/types.ts`
- Migrations handle existing databases

---

### Task 2: WPScan Docker Container in docker-compose

**Files:** `docker-compose.yml`

**Action:**

Add WPScan service to `docker-compose.yml`. WPScan is a CLI tool, not a long-running service, so we configure it as a utility container that the server can exec into:

```yaml
wpscan:
  image: wpscanteam/wpscan:latest
  entrypoint: ["tail", "-f", "/dev/null"]  # Keep container running for exec
  restart: unless-stopped
  environment:
    - WPSCAN_API_TOKEN=${WPSCAN_API_TOKEN:-}
  volumes:
    - wpscan-data:/root/.wpscan
```

Add `wpscan-data` volume to persist WPScan's local database cache.

Also add `WPSCAN_API_TOKEN` to `.env.example` (optional, for vulnerability DB enrichment).

**Verify:**
```bash
docker-compose config --services | grep wpscan
```

**Done when:**
- `wpscan` service defined in `docker-compose.yml`
- Container stays running for `docker exec` calls
- `WPSCAN_API_TOKEN` in `.env.example` (optional)

---

### Task 3: Database Queries — Analysis CRUD & Tags

**Files:** `server/src/db/queries/analyses.ts`, `server/src/db/queries/tags.ts`, `server/src/db/queries/vulnerabilities.ts`

**Action:**

Create `analyses.ts` with:
- `createAnalysis(siteId, jobId)` — insert pending analysis row
- `updateAnalysis(id, data)` — update analysis with results
- `getAnalysisBySiteId(siteId)` — get latest analysis for a site
- `getAnalysisByJobId(jobId)` — get all analyses for a job
- `listAnalyses(filters)` — paginated list with filters (status, priority)

Create `tags.ts` with:
- `addTag(siteId, tag)` — upsert tag (ignore duplicate)
- `removeTag(siteId, tag)` — delete tag
- `getTagsForSite(siteId)` — list tags for a site
- `getTagsForSites(siteIds)` — batch get tags (returns `Record<number, string[]>`)
- `listSitesByTag(tag, pagination)` — find sites with a specific tag

Create `vulnerabilities.ts` with:
- `importVulnerabilities(rows)` — bulk insert/replace vulnerability data
- `clearVulnerabilities()` — truncate table before re-import
- `findVulnerabilitiesBySlug(slug)` — lookup by software_slug
- `getVulnerabilityStats()` — count by type, severity
- `getLastImportDate()` — when was the DB last updated

Follow existing patterns from `contacts.ts` and `sites.ts` — parameterized queries, `getDb()`, typed returns.

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- All three query modules compile without errors
- Functions follow existing patterns (parameterized queries, typed returns)
- CRUD operations cover all needed analysis workflows

---

### Task 4: Analysis Worker with Parallel Processing

**Files:** `server/src/workers/analysis-worker.ts`, `server/src/index.ts`

**Action:**

Create `analysis-worker.ts` following the enrichment worker pattern but with parallel processing:

```typescript
const POLL_INTERVAL_MS = 2000;
const MAX_CONCURRENT = 5;  // 5 parallel analyses per batch
```

Key differences from enrichment worker:
- Process sites in parallel batches of 5 (use `Promise.allSettled`)
- Each site analysis calls three services sequentially: PSI → SSL → WPScan
- After all three complete, calculate composite score and update analysis row
- Update `analysis_status` on sites table (`pending` → `analyzing` → `analyzed` / `error`)
- Add tags: `'analyzed'` on success
- Update `pipeline_stage` to `'analysis'`

Worker lifecycle:
1. Poll for pending `analysis` jobs
2. For each job, get `siteIds` from config
3. Process in batches of `MAX_CONCURRENT`
4. For each site: run analysis services (placeholder calls for now — Plan 2 implements actual services)
5. Update progress after each batch

Register in `server/src/index.ts`:
- Import and call `startAnalysisWorker()` at startup
- Add `stopAnalysisWorker()` to shutdown

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- Analysis worker polls for `analysis` type jobs
- Parallel batch processing with `MAX_CONCURRENT = 5`
- Worker registered in server startup and shutdown
- Placeholder service calls ready for Plan 2

---

### Task 5: Analysis API Routes

**Files:** `server/src/routes/analysis.ts`, `server/src/app.ts`

**Action:**

Create `analysis.ts` routes following enrichment route patterns:

- `POST /api/analysis/jobs` — Create analysis job
  - Body: `{ siteIds: number[] }`
  - Validates sites exist
  - Updates `pipeline_stage = 'analysis'`, `analysis_status = 'pending'`
  - Creates job with `type: 'analysis'`
  - Adds `'analyzing'` tag to sites

- `GET /api/analysis/jobs` — List analysis jobs
- `GET /api/analysis/jobs/:id` — Get job status with progress
- `DELETE /api/analysis/jobs/:id` — Cancel running job

- `GET /api/analysis/sites` — List sites in analysis stage
  - Supports pagination, search, sort, filter by `analysis_status`
  - Includes latest analysis data (health_score, priority_classification)
  - Includes tags for each site

- `GET /api/analysis/sites/:id` — Get full analysis detail for a site
  - Returns site + latest `site_analyses` row with all scores and raw data

- `POST /api/analysis/move` — Move sites to analysis stage
  - Body: `{ siteIds: number[] }`
  - Updates `pipeline_stage = 'analysis'`, `analysis_status = 'pending'`

- `POST /api/analysis/reanalyze` — Re-run analysis on sites
  - Body: `{ siteIds: number[] }`
  - Resets `analysis_status = 'pending'`, creates new job

Mount in `app.ts`: `app.use('/api/analysis', analysisRoutes)`

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- All routes compile and follow existing patterns
- Routes mounted in `app.ts`
- Job creation, listing, cancellation work
- Site listing with analysis data and tags

---

### Task 6: Tags API Routes

**Files:** `server/src/routes/tags.ts`, `server/src/app.ts`

**Action:**

Create lightweight tags routes:

- `GET /api/tags/site/:id` — Get tags for a site
- `GET /api/tags/sites` — Batch get tags for multiple sites (query param: `ids=1,2,3`)

Mount in `app.ts`: `app.use('/api/tags', tagRoutes)`

Note: Tags are primarily system-assigned (by workers), so no POST/DELETE routes for now. The worker adds tags automatically when analysis completes.

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- Tag read routes compile and return correct data
- Mounted in `app.ts`

---

## Verification

After all tasks complete:

```bash
# TypeScript compiles
cd server && npx tsc --noEmit

# Schema is valid (fresh DB creation)
rm -f data/test.db && cd server && npx tsx -e "
  process.env.DB_PATH = '../data/test.db';
  const { getDb } = require('./src/db');
  const db = getDb();
  const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all();
  console.log('Tables:', tables.map(t => t.name));
  console.log('OK');
" && rm -f data/test.db

# Server starts without errors
cd server && timeout 5 npx tsx src/index.ts 2>&1 | head -20
```

## Success Criteria

- [ ] `site_analyses` table stores all analysis dimensions (PSI, SSL, WPScan, scores)
- [ ] `site_tags` table supports multiple tags per site with unique constraint
- [ ] `wp_vulnerabilities` table ready for OWVD import
- [ ] WPScan Docker container defined in `docker-compose.yml`
- [ ] Analysis worker processes jobs in parallel batches of 5
- [ ] Analysis API routes handle job CRUD, site listing, move, and reanalyze
- [ ] Tags API routes return tags for sites
- [ ] All new code compiles with `tsc --noEmit`
- [ ] Server starts with analysis worker registered

## Output

**Files created:**
- `server/src/db/queries/analyses.ts` — Analysis CRUD operations
- `server/src/db/queries/tags.ts` — Tag management queries
- `server/src/db/queries/vulnerabilities.ts` — Vulnerability DB queries
- `server/src/workers/analysis-worker.ts` — Parallel analysis job processor
- `server/src/routes/analysis.ts` — Analysis API endpoints
- `server/src/routes/tags.ts` — Tags API endpoints

**Files modified:**
- `server/src/db/schema.sql` — Added site_analyses, site_tags, wp_vulnerabilities tables
- `server/src/db/migrations.ts` — Added migration for new tables and columns
- `shared/types.ts` — Added analysis types, tag types, vulnerability types
- `server/src/index.ts` — Register analysis worker
- `server/src/app.ts` — Mount analysis and tags routes
- `docker-compose.yml` — Added wpscan service
- `.env.example` — Added WPSCAN_API_TOKEN
