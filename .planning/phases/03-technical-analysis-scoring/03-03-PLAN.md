---
phase: 3
plan: 3
name: Analysis UI & Classification
wave: 2
depends_on: ["03-01"]
autonomous: true
---

# Phase 3 Plan 3: Analysis UI & Classification

## Objective

Build the Analysis page in the client with site listing, score breakdown cards, drill-down detail view, priority classification display, auto-qualify indicators, manual review queue filtering, tag filtering, and the "Analyze" batch action from the enrichment table. Also add the vulnerability DB update button to the Settings page.

## Context

**Requirements addressed:** REQ-022, REQ-023, REQ-024
**Phase goal contribution:** This is the user-facing layer — without it, analysis results are invisible. After this plan, users can trigger analysis, view scores, filter by priority, and manage the review queue.

## Tasks

### Task 1: Analysis Page — Site List with Scores

**Files:** `client/src/pages/AnalysisPage.tsx`

**Action:**

Replace the existing placeholder AnalysisPage with a full implementation. Follow the EnrichmentPage pattern:

**Layout:**
- Top section: Job status bar (active jobs with progress), "Analyze Selected" button
- Main section: Sites table with analysis data

**Sites table columns:**
- Checkbox (for bulk selection)
- Domain (link)
- Health Score (0-100 with color-coded badge: red <40, orange 40-55, yellow 55-75, green >75)
- Priority (Critical/High/Medium/Low badge)
- Security Score
- Performance Score
- WP Health Score
- Analysis Status (pending/analyzing/analyzed/error)
- Tags (pill badges)
- Actions (View Detail, Re-analyze)

**Features:**
- Fetch sites from `GET /api/analysis/sites` with pagination
- Poll for active jobs from `GET /api/analysis/jobs`
- Bulk select with "Analyze Selected" → `POST /api/analysis/jobs`
- Filter by: analysis_status, priority_classification, tag
- Sort by: health_score, domain, updated_at
- Search by domain
- Re-analyze button per row → `POST /api/analysis/reanalyze`

**API integration:**
- Use existing `fetchGet`/`fetchPost` from `client/src/lib/http.ts`
- Poll active jobs every 3 seconds (follow enrichment pattern)
- Refresh site list when job completes

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Analysis page shows sites with health scores and priority badges
- Pagination, search, sort, and filter work
- Bulk select and analyze action creates jobs
- Job progress displayed in real-time
- Re-analyze button works per site

---

### Task 2: Score Breakdown Cards Component

**Files:** `client/src/components/analysis/ScoreBreakdown.tsx`

**Action:**

Create a reusable score breakdown component that shows the three sub-scores as visual cards:

**Design:**
- Three cards in a row: Security (40%), Performance (30%), WP Health (30%)
- Each card shows:
  - Category name and weight
  - Score as large number (0-100) with color coding
  - Circular progress indicator or bar
  - Brief status text (e.g., "SSL expired", "3 critical vulns", "WP outdated")

**Color coding:**
- 0-39: Red (`text-red-600`, `bg-red-50`)
- 40-55: Orange (`text-orange-600`, `bg-orange-50`)
- 56-75: Yellow (`text-yellow-600`, `bg-yellow-50`)
- 76-100: Green (`text-green-600`, `bg-green-50`)

**Props:**
```typescript
interface ScoreBreakdownProps {
  securityScore: number | null;
  performanceScore: number | null;
  wpHealthScore: number | null;
  healthScore: number | null;
  priorityClassification: string | null;
}
```

Use Tailwind CSS for styling. Use Lucide icons for category indicators (Shield for security, Gauge for performance, Code for WP health).

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Three score cards render with correct colors and values
- Handles null scores gracefully (shows "N/A" or "Pending")
- Responsive layout (stacks on mobile)

---

### Task 3: Analysis Detail Drill-Down View

**Files:** `client/src/components/analysis/AnalysisDetail.tsx`

**Action:**

Create a detail view component that shows full analysis data for a single site. This can be a modal or a slide-over panel triggered from the "View Detail" action in the table.

**Sections:**

1. **Header:** Domain, overall health score (large), priority badge, analyzed date
2. **Score Breakdown Cards** (reuse Task 2 component)
3. **Security Details:**
   - SSL status: valid/invalid, issuer, expiry date, days until expiry, protocol, cipher
   - Vulnerabilities found: count by severity, list of CVEs with titles
   - Config backups exposed: yes/no
   - DB exports exposed: yes/no
4. **Performance Details:**
   - PSI scores: performance, accessibility, SEO, best practices (each with bar)
   - Key metrics from Lighthouse (if available in raw data)
5. **WordPress Health Details:**
   - WP version and status (latest/outdated/insecure)
   - Theme: name, version
   - Plugins: list with version and outdated status
   - Users detected
6. **Actions:** Re-analyze button, Move to next stage (future)

**Data source:** `GET /api/analysis/sites/:id` returns full analysis data

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Detail view shows all analysis dimensions with structured layout
- Security, performance, and WP health sections display relevant data
- Vulnerability list shows CVEs with severity badges
- Plugin list shows outdated status
- Re-analyze button triggers new analysis

---

### Task 4: "Move to Analysis" Action on Enrichment Page

**Files:** `client/src/pages/EnrichmentPage.tsx`

**Action:**

Add a batch action to the enrichment page that moves selected sites to the analysis stage:

1. Add "Move to Analysis" button in the batch actions bar (alongside existing actions)
2. On click: call `POST /api/analysis/move` with selected site IDs
3. Show success toast/notification with count of sites moved
4. Refresh the enrichment sites list (moved sites disappear from enrichment view)

Follow the existing pattern for "Move to Enrichment" on the discovery page.

Also add an "Analyze" batch action that directly creates an analysis job:
1. "Analyze" button in batch actions
2. Calls `POST /api/analysis/jobs` with selected site IDs
3. Shows notification: "Analysis job created for X sites"
4. Optionally navigate to /analysis page

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- "Move to Analysis" button appears in enrichment batch actions
- Selected sites move to analysis stage on click
- "Analyze" button creates analysis job directly
- Sites disappear from enrichment list after moving

---

### Task 5: Priority Classification & Queue Filtering

**Files:** `client/src/pages/AnalysisPage.tsx`, `client/src/components/analysis/QueueFilters.tsx`

**Action:**

Add priority-based filtering and queue views to the Analysis page:

**Filter bar component (`QueueFilters.tsx`):**
- Quick filter tabs/buttons:
  - "All" — show all analyzed sites
  - "Auto-Qualified" — score <40 (critical/high priority) — highlighted/badged
  - "Manual Review" — score 40-75 (medium priority)
  - "Low Priority" — score >75
  - "Pending" — not yet analyzed
  - "Errors" — analysis failed
- Count badge on each tab showing number of sites in that category

**Auto-qualify indicator:**
- Sites with score <40 get a special badge: "Auto-Qualified" in green
- These are ready for outreach pipeline (Phase 5)

**Manual review queue:**
- Sites with score 40-75 show "Needs Review" badge in yellow
- Future: add approve/reject actions (out of scope for Phase 3, but leave UI hooks)

**Implementation:**
- Filter tabs update the `analysis_status` and/or `priority_classification` query params
- Counts fetched from API or calculated client-side from loaded data
- Active filter highlighted

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Filter tabs show correct counts per category
- Clicking a tab filters the sites table
- Auto-qualified sites have distinct visual indicator
- Manual review sites have "Needs Review" badge
- All filter combinations work with pagination

---

### Task 6: Tag Display & Filtering in UI

**Files:** `client/src/components/common/TagBadges.tsx`, `client/src/pages/AnalysisPage.tsx`

**Action:**

Create a reusable tag badge component and integrate tag filtering:

**TagBadges component:**
```typescript
interface TagBadgesProps {
  tags: string[];
  size?: 'sm' | 'md';
}
```
- Render each tag as a small pill badge
- Color coding by tag type:
  - `discovered` → gray
  - `enriched` → blue
  - `analyzed` → green
  - `error` → red
- Compact display: show first 3 tags, "+N more" if overflow

**Integration:**
- Add TagBadges to the analysis sites table (Tags column)
- Add tag filter dropdown to the filter bar
- Fetch tags via `GET /api/tags/sites?ids=...` when sites load
- Also usable on enrichment and discovery pages (future)

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Tag badges render with correct colors per tag type
- Tags column shows in analysis table
- Tag filter dropdown filters sites by tag
- Component is reusable across pages

---

### Task 7: Vulnerability DB Update in Settings Page

**Files:** `client/src/pages/SettingsPage.tsx`

**Action:**

Add a "Vulnerability Database" section to the existing Settings page:

**UI:**
- Section header: "WordPress Vulnerability Database"
- Status display: "Last updated: [date]" or "Never updated"
- Stats: "X vulnerabilities tracked (Y plugins, Z themes, W core)"
- "Update Now" button
  - On click: `POST /api/settings/vuln-db/update`
  - Show loading spinner during update
  - Show success/error toast on completion
  - Refresh status after update

**Placement:** Add as a new section below existing settings (model/prompt editor).

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- Vulnerability DB section visible on Settings page
- Last update date and stats displayed
- "Update Now" button triggers download and import
- Loading state shown during update
- Success/error feedback displayed

---

## Verification

After all tasks complete:

```bash
# Client compiles
cd client && npx tsc --noEmit

# Client builds
cd client && npm run build

# Dev server starts
cd client && npm run dev -- --host 0.0.0.0 &
sleep 3
curl -s http://localhost:5173/analysis | head -5
kill %1
```

Manual verification:
1. Navigate to /analysis — page loads with sites table
2. Navigate to /enrichment — "Move to Analysis" and "Analyze" buttons visible
3. Select sites on enrichment → click "Analyze" → job created, sites appear on analysis page
4. Analysis completes → scores visible, priority badges shown
5. Click "View Detail" → drill-down shows full breakdown
6. Filter by "Auto-Qualified" → only score <40 sites shown
7. Filter by "Manual Review" → only score 40-75 sites shown
8. Navigate to /settings → Vulnerability DB section visible, "Update Now" works

## Success Criteria

- [ ] Analysis page displays sites with health scores, priority badges, and tags
- [ ] Score breakdown cards show Security/Performance/WP Health with color coding
- [ ] Detail drill-down shows full analysis data (SSL, PSI, WPScan, vulnerabilities)
- [ ] "Move to Analysis" and "Analyze" batch actions work from enrichment page
- [ ] Priority filter tabs (Auto-Qualified, Manual Review, Low Priority) with counts
- [ ] Auto-qualified sites (<40) have distinct visual indicator
- [ ] Tag badges display on sites with color coding
- [ ] Vulnerability DB update button works in Settings page
- [ ] All components compile and build without errors
- [ ] Re-analyze action works from both table and detail view

## Output

**Files created:**
- `client/src/components/analysis/ScoreBreakdown.tsx` — Score cards component
- `client/src/components/analysis/AnalysisDetail.tsx` — Detail drill-down view
- `client/src/components/analysis/QueueFilters.tsx` — Priority filter tabs
- `client/src/components/common/TagBadges.tsx` — Reusable tag badges

**Files modified:**
- `client/src/pages/AnalysisPage.tsx` — Full analysis page implementation
- `client/src/pages/EnrichmentPage.tsx` — Add "Move to Analysis" and "Analyze" batch actions
- `client/src/pages/SettingsPage.tsx` — Add vulnerability DB update section
