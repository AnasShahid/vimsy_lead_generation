---
phase: 1
plan: 2
name: Schema & Enriched Import — Database Columns + Excel/CSV Upload
wave: 1
depends_on: none
autonomous: true
---

# Phase 1 Plan 2: Schema & Enriched Import

## Objective

Extend the database schema and shared types with AI-enrichment columns (company name, industry/segment, fit reasoning, priority, outreach status, notes, emails available count). Then build an enriched Excel/CSV upload endpoint that imports pre-analyzed leads in the `vimsy_cold_outreach_leads` format directly into the database.

## Context

**Requirements addressed:** REQ-013 (schema portion), REQ-014
**Phase goal contribution:** Establishes the enriched data model that all Phase 1 work depends on, and enables importing externally-produced lead lists.

## Tasks

### Task 1: Extend database schema with enrichment columns

**Files:** `server/src/db/schema.sql`

**Action:**
Add new columns to the `sites` table. Use an `ALTER TABLE` migration approach — create a new migration file or add ALTER statements that run on startup if columns don't exist. The columns:

```sql
company_name TEXT,
industry_segment TEXT,
ai_fit_reasoning TEXT,
emails_available_count INTEGER DEFAULT 0,
priority TEXT DEFAULT 'cold',       -- 'hot', 'warm', 'cold'
outreach_status TEXT DEFAULT 'not_started',  -- 'not_started', 'in_progress', 'done'
notes TEXT
```

Implementation approach:
- Add columns to the `CREATE TABLE` statement in `schema.sql` for fresh installs
- Create `server/src/db/migrations.ts` with a function `runMigrations()` that uses `ALTER TABLE sites ADD COLUMN ... IF NOT EXISTS` pattern (SQLite doesn't support IF NOT EXISTS on ALTER, so catch errors for existing columns)
- Call `runMigrations()` from `server/src/db/index.ts` after database initialization
- Add index: `CREATE INDEX IF NOT EXISTS idx_sites_priority ON sites(priority)`
- Add index: `CREATE INDEX IF NOT EXISTS idx_sites_country ON sites(country)`

**Verify:**
```bash
# Check schema has new columns
grep "company_name" server/src/db/schema.sql
grep "priority" server/src/db/schema.sql
grep "outreach_status" server/src/db/schema.sql
```

**Done when:**
- `schema.sql` includes all 7 new columns
- Migration file exists and safely adds columns to existing databases
- New indexes created for priority and country

---

### Task 2: Update shared types and Site interface

**Files:** `shared/types.ts`

**Action:**
1. Add new fields to `Site` interface:
   ```typescript
   company_name: string | null;
   industry_segment: string | null;
   ai_fit_reasoning: string | null;
   emails_available_count: number;
   priority: LeadPriority;
   outreach_status: OutreachStatus;
   notes: string | null;
   ```

2. Add new type aliases:
   ```typescript
   export type LeadPriority = 'hot' | 'warm' | 'cold';
   export type OutreachStatus = 'not_started' | 'in_progress' | 'done';
   ```

3. Add enriched CSV row interface for the vimsy_cold_outreach_leads format:
   ```typescript
   export interface EnrichedLeadRow {
     '#'?: string;
     'Company Name': string;
     'Domain': string;
     'Industry / Segment': string;
     'Why They\'re a Good Fit': string;
     'Emails Available': string;
     'Priority': string;
     'Outreach Status': string;
     'Notes': string;
   }
   ```

4. Update `SiteCSVRow` to include the new fields
5. Update `CSV_COLUMNS` array to include new column names
6. Add new fields to `SiteFilterParams`:
   ```typescript
   priority?: LeadPriority;
   country?: string;
   ```

**Verify:**
```bash
grep "company_name" shared/types.ts
grep "LeadPriority" shared/types.ts
grep "EnrichedLeadRow" shared/types.ts
```

**Done when:**
- `Site` interface has all 7 new fields
- `LeadPriority` and `OutreachStatus` types exported
- `EnrichedLeadRow` interface matches the Excel format
- `SiteFilterParams` includes priority and country filters

---

### Task 3: Update database queries for new fields

**Files:** `server/src/db/queries/sites.ts`

**Action:**
1. In `upsertSite()`:
   - Add new fields to the `updatable` array: `'company_name'`, `'industry_segment'`, `'ai_fit_reasoning'`, `'emails_available_count'`, `'priority'`, `'outreach_status'`, `'notes'`
   - Add new fields to the INSERT statement columns and values

2. In `listSites()`:
   - Add filter support for `priority` (WHERE clause)
   - Add filter support for `country` (WHERE clause)
   - Add `'priority'`, `'company_name'`, `'country'` to `allowedSortColumns`

3. In `getAllSitesForExport()`:
   - Add filter support for `priority`

4. In `normalizeSiteRow()`:
   - Ensure new fields pass through correctly (strings and numbers need no normalization)

**Verify:**
```bash
grep "company_name" server/src/db/queries/sites.ts
grep "priority" server/src/db/queries/sites.ts
```

**Done when:**
- `upsertSite` handles all 7 new fields in both INSERT and UPDATE paths
- `listSites` supports filtering by priority and country
- Sorting works on new columns

---

### Task 4: Create enriched Excel/CSV import endpoint

**Files:** `server/src/routes/csv.ts`, `server/src/utils/csv.ts`

**Action:**
1. Install `xlsx` package for Excel parsing:
   - Add to `server/package.json` dependencies

2. In `server/src/utils/csv.ts`:
   - Add function `parseEnrichedLeads(buffer: Buffer, filename: string): EnrichedLeadRow[]`
     - If filename ends in `.xlsx` or `.xls`: use `xlsx` library to parse
     - If filename ends in `.csv`: parse as CSV
     - Map column headers to `EnrichedLeadRow` fields (handle variations like "Company Name" vs "company_name")
     - Return array of parsed rows
   - Add function `enrichedLeadToSite(row: EnrichedLeadRow): Partial<Site>`
     - Maps: `Company Name` → `company_name`, `Domain` → `domain` + construct `url`, `Industry / Segment` → `industry_segment`, `Why They're a Good Fit` → `ai_fit_reasoning`, `Emails Available` → `emails_available_count`, `Priority` → `priority` (normalize to lowercase), `Outreach Status` → `outreach_status` (normalize), `Notes` → `notes`
   - Update `sitesToCsv()` to include new columns in export

3. In `server/src/routes/csv.ts`:
   - Add new endpoint: `POST /api/csv/import-enriched`
   - Accept file upload (Excel or CSV) via multer
   - Parse using `parseEnrichedLeads()`
   - For each row, call `upsertSite()` with mapped fields
   - Set `discovery_source` to `'manual'`, `pipeline_stage` to `'discovered'`
   - Return count of imported/updated sites

**Verify:**
```bash
# Check endpoint exists
grep "import-enriched" server/src/routes/csv.ts
# Check xlsx dependency
grep "xlsx" server/package.json
```

**Done when:**
- `POST /api/csv/import-enriched` accepts Excel (.xlsx) and CSV files
- Parses the vimsy_cold_outreach_leads format correctly
- Imports rows into database with all enrichment fields populated
- Returns success response with import count

---

### Task 5: Add enriched import UI to DiscoveryPage

**Files:** `client/src/pages/DiscoveryPage.tsx`, `client/src/components/shared/CSVImport.tsx`, `client/src/lib/api.ts`

**Action:**
1. In `client/src/lib/api.ts`:
   - Add method `importEnrichedFile(file: File): Promise<any>` that POSTs to `/api/csv/import-enriched` with multipart form data

2. Update the existing `import` tab in DiscoveryPage or add a new tab `'import-enriched'`:
   - Add a new tab: `{ key: 'import-enriched', label: 'Import Leads', icon: <FileSpreadsheet size={16} /> }` (use lucide `FileSpreadsheet` icon)
   - Create a simple upload component or extend `CSVImport` to support:
     - File picker accepting `.xlsx`, `.xls`, `.csv`
     - Description text: "Import pre-analyzed leads in Vimsy format (Company Name, Domain, Industry, Priority, etc.)"
     - Upload button that calls `api.importEnrichedFile(file)`
     - Success message showing count of imported leads

3. Keep the existing CSV import tab as-is (it imports raw URLs for WordPress detection)

**Verify:**
```bash
grep "import-enriched" client/src/pages/DiscoveryPage.tsx
grep "importEnrichedFile" client/src/lib/api.ts
```

**Done when:**
- "Import Leads" tab visible in DiscoveryPage
- User can upload .xlsx or .csv file in vimsy_cold_outreach_leads format
- Imported leads appear in the sites table with enrichment fields populated
- Existing CSV import (raw URLs) still works

---

## Verification

After all tasks complete:

```bash
# Server compiles
cd server && npx tsc --noEmit

# Client compiles
cd client && npx tsc --noEmit

# Schema has new columns
grep -c "company_name\|industry_segment\|ai_fit_reasoning\|emails_available_count\|priority\|outreach_status\|notes" server/src/db/schema.sql

# Import endpoint exists
grep "import-enriched" server/src/routes/csv.ts

# Types updated
grep "LeadPriority" shared/types.ts
```

## Success Criteria

- [ ] Database schema has 7 new enrichment columns with migration support
- [ ] `Site` interface and shared types include all new fields
- [ ] `upsertSite` and `listSites` handle new fields (insert, update, filter, sort)
- [ ] Enriched Excel/CSV import endpoint parses vimsy_cold_outreach_leads format
- [ ] UI has "Import Leads" tab for uploading enriched files
- [ ] Existing CSV import (raw URLs) unaffected
- [ ] TypeScript compiles on both server and client

## Output

**Files created:**
- `server/src/db/migrations.ts` — Safe column addition for existing databases
- (No new component file — extends existing import UI or adds tab inline)

**Files modified:**
- `server/src/db/schema.sql` — 7 new columns + 2 new indexes
- `shared/types.ts` — New fields on Site, new types, EnrichedLeadRow interface
- `server/src/db/queries/sites.ts` — Handle new fields in CRUD + filtering
- `server/src/utils/csv.ts` — Enriched lead parsing and mapping functions
- `server/src/routes/csv.ts` — New import-enriched endpoint
- `server/package.json` — Add xlsx dependency
- `client/src/pages/DiscoveryPage.tsx` — Add Import Leads tab
- `client/src/lib/api.ts` — Add importEnrichedFile method
