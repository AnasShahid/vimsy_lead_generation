---
phase: 2
plan: 1
name: Contacts Schema & Hunter.io Domain Search Backend
wave: 1
depends_on: none
autonomous: true
---

# Phase 2 Plan 1: Contacts Schema & Hunter.io Domain Search Backend

## Objective

Create the `contacts` table in the database, build the Hunter.io domain-search service, add an enrichment worker that processes batch enrichment jobs, and expose API routes for enrichment operations. This is the data foundation for the entire enrichment phase.

## Context

**Requirements addressed:** REQ-016
**Phase goal contribution:** Provides the backend infrastructure for finding and storing contact emails per domain.

## Tasks

### Task 1: Create contacts table and DB queries

**Files:** `server/src/db/schema.sql`, `server/src/db/migrations.ts`, `server/src/db/queries/contacts.ts`, `shared/types.ts`

**Action:**

Add a `contacts` table to the schema:
```sql
CREATE TABLE IF NOT EXISTS contacts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  site_id INTEGER NOT NULL REFERENCES sites(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  first_name TEXT,
  last_name TEXT,
  full_name TEXT,
  position TEXT,
  position_raw TEXT,
  seniority TEXT,
  department TEXT,
  type TEXT,  -- 'personal' or 'generic'
  confidence INTEGER,
  linkedin_url TEXT,
  twitter TEXT,
  phone_number TEXT,
  verification_status TEXT,  -- 'valid', 'invalid', 'accept_all', 'unknown'
  verification_date TEXT,
  enrichment_source TEXT,  -- 'hunter', 'snov'
  enrichment_job_id TEXT REFERENCES jobs(id),
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  UNIQUE(site_id, email)  -- prevent duplicate contacts per site
);
```

Add indexes:
```sql
CREATE INDEX IF NOT EXISTS idx_contacts_site_id ON contacts(site_id);
CREATE INDEX IF NOT EXISTS idx_contacts_email ON contacts(email);
CREATE INDEX IF NOT EXISTS idx_contacts_verification ON contacts(verification_status);
```

Add migration in `migrations.ts` for existing databases to add the contacts table.

Add `enrichment_status` column to `sites` table: `TEXT DEFAULT NULL` — values: `null`, `pending`, `enriching`, `enriched`, `error`.

Create `server/src/db/queries/contacts.ts` with:
- `upsertContact(contact)` — insert or update by (site_id, email) unique constraint; on conflict update all fields
- `getContactsBySiteId(siteId)` — return all contacts for a site
- `getContactCountBySiteId(siteId)` — return count
- `deleteContactsBySiteId(siteId)` — for cleanup if needed

Add shared types in `shared/types.ts`:
- `Contact` interface matching the DB columns
- `EnrichmentStatus` type: `'pending' | 'enriching' | 'enriched' | 'error'`
- `HunterDomainSearchConfig` interface for enrichment job config (domain, company, seniority[], department[], type, required_field, limit, offset, location, job_titles[])
- `EnrichmentProvider` type: `'hunter' | 'snov'`
- Add `enrichment_status` to `Site` interface

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- contacts table created in schema.sql
- Migration adds contacts table + enrichment_status column to existing DBs
- CRUD queries for contacts compile
- Shared types updated with Contact, EnrichmentStatus, HunterDomainSearchConfig

---

### Task 2: Build Hunter.io domain-search service

**Files:** `server/src/services/enrichment/hunter-domain-search.ts`, `server/src/services/enrichment/index.ts`

**Action:**

Create `server/src/services/enrichment/hunter-domain-search.ts`:
- Function `hunterDomainSearch(config: HunterDomainSearchConfig, apiKey: string): Promise<HunterDomainSearchResult>`
- Calls `GET https://api.hunter.io/v2/domain-search` with query params:
  - `domain` (required)
  - `company` (optional)
  - `type` — 'personal' or 'generic' (optional)
  - `seniority` — comma-separated (optional)
  - `department` — comma-separated (optional)
  - `required_field` — 'full_name', 'position', 'phone_number' (optional)
  - `limit` — default 5, max 100
  - `offset` — for pagination
  - `location` — JSON object with include/exclude (optional)
  - `api_key`
- Parse response: extract `data.emails[]` array, `data.organization`, `data.pattern`, `meta.results`
- Map each email object to our `Contact` shape
- Handle errors: 401 (invalid key), 429 (rate limit), 422 (wrong params)
- Rate limit: 15 req/sec, 500 req/min — use existing rate limiter pattern

Create `server/src/services/enrichment/index.ts`:
- Registry pattern similar to discovery providers
- Export `runEnrichment(siteId, provider, config, apiKey, jobId)` that calls the appropriate provider and upserts contacts

**Verify:**
```bash
cd server && npx tsc --noEmit
```

**Done when:**
- Hunter domain-search service compiles and handles all API params
- Rate limiting configured for Hunter.io (15/sec, 500/min)
- Service maps API response to Contact records and upserts them
- Error handling for all Hunter.io error codes

---

### Task 3: Create enrichment worker and API routes

**Files:** `server/src/workers/enrichment-worker.ts`, `server/src/routes/enrichment.ts`, `server/src/index.ts`, `shared/types.ts`

**Action:**

Create `server/src/workers/enrichment-worker.ts`:
- Similar pattern to `discovery-worker.ts`
- Polls for pending jobs of type `'enrichment'`
- For each job: reads config (list of site IDs + Hunter filters + API key)
- Iterates sites, calls `hunterDomainSearch` for each domain
- Updates site `enrichment_status`: `enriching` → `enriched` (or `error`)
- Updates job progress after each site
- Handles abort signal for cancellation
- On API quota exhaustion (429): pause 30s and retry, or mark remaining as error

Create `server/src/routes/enrichment.ts`:
- `POST /api/enrichment/jobs` — create enrichment job (body: { siteIds, provider, config, apiKey })
  - Validates siteIds not empty, provider is 'hunter' or 'snov'
  - Updates selected sites' `pipeline_stage` to 'enrichment' and `enrichment_status` to 'pending' (if not already)
  - Creates job record with type='enrichment'
  - Returns job ID
- `GET /api/enrichment/jobs` — list enrichment jobs
- `GET /api/enrichment/jobs/:id` — get job status/progress
- `DELETE /api/enrichment/jobs/:id` — cancel job
- `GET /api/enrichment/sites` — list sites in enrichment stage (pipeline_stage = 'enrichment')
- `GET /api/enrichment/sites/:id/contacts` — get contacts for a site
- `POST /api/sites/move-to-enrichment` — move selected sites to enrichment stage (update pipeline_stage)

Register routes in `server/src/index.ts` (or `app.ts`).
Start enrichment worker alongside discovery worker.

Add `'enrichment'` to `JobType` in shared types.

**Verify:**
```bash
cd server && npx tsc --noEmit
# Test endpoints:
curl http://localhost:3001/api/enrichment/sites
curl -X POST http://localhost:3001/api/sites/move-to-enrichment -H "Content-Type: application/json" -d '{"siteIds":[1,2]}'
```

**Done when:**
- Enrichment worker polls and processes enrichment jobs
- All API routes compile and respond correctly
- Sites can be moved to enrichment stage via API
- Contacts retrievable per site via API
- Job progress tracking works for enrichment jobs

---

## Verification

After all tasks complete:

```bash
cd server && npx tsc --noEmit
# Start server and verify endpoints respond
curl http://localhost:3001/api/enrichment/sites
```

## Success Criteria

- [ ] `contacts` table exists with proper schema and indexes
- [ ] `enrichment_status` column added to sites table
- [ ] Hunter.io domain-search service calls API with all filter params
- [ ] Contacts upserted with deduplication by (site_id, email)
- [ ] Enrichment worker processes batch jobs with progress
- [ ] API routes for enrichment jobs, sites, and contacts all functional
- [ ] Rate limiting prevents Hunter.io API abuse
- [ ] Re-enrichment adds new contacts without deleting existing ones

## Output

**Files created:**
- `server/src/db/queries/contacts.ts` — Contact CRUD operations
- `server/src/services/enrichment/hunter-domain-search.ts` — Hunter.io domain-search API client
- `server/src/services/enrichment/index.ts` — Enrichment provider registry
- `server/src/workers/enrichment-worker.ts` — Background enrichment job processor
- `server/src/routes/enrichment.ts` — Enrichment API endpoints

**Files modified:**
- `server/src/db/schema.sql` — Add contacts table
- `server/src/db/migrations.ts` — Add migration for contacts + enrichment_status
- `shared/types.ts` — Add Contact, EnrichmentStatus, HunterDomainSearchConfig, EnrichmentProvider types
- `server/src/index.ts` — Register enrichment routes and worker
