---
phase: 2
plan: 2
name: Pipeline Stage Management & Move to Enrichment
wave: 1
depends_on: none
autonomous: true
---

# Phase 2 Plan 2: Pipeline Stage Management & Move to Enrichment

## Objective

Add "Move to Enrichment" batch action to the Discovery results table, update pipeline stage tracking so sites flow from `discovered` → `enrichment`, and add the client-side API methods for enrichment operations. This bridges Discovery and Enrichment in the UI.

## Context

**Requirements addressed:** REQ-016 (partial — pipeline flow)
**Phase goal contribution:** Enables the user workflow of selecting discovered sites and moving them into the enrichment pipeline.

## Tasks

### Task 1: Add "Move to Enrichment" batch action in Discovery table

**Files:** `client/src/components/discovery/SiteResultsTable.tsx`, `client/src/lib/api.ts`

**Action:**

In `client/src/lib/api.ts`:
- Add `moveToEnrichment(siteIds: number[])` — POST `/api/sites/move-to-enrichment`
- Add `getEnrichmentSites()` — GET `/api/enrichment/sites`
- Add `getContactsForSite(siteId: number)` — GET `/api/enrichment/sites/:id/contacts`
- Add `createEnrichmentJob(data)` — POST `/api/enrichment/jobs`
- Add `getEnrichmentJobs()` — GET `/api/enrichment/jobs`

In `SiteResultsTable.tsx`:
- Add a "Move to Enrichment" button in the batch action toolbar (next to existing WP Analyze, AI Analyze, etc.)
- Use ArrowRight or Send icon from Lucide
- On click: call `moveToEnrichment(selectedIds)`, show success toast, refresh the table
- Sites that are moved will have `pipeline_stage = 'enrichment'` and should no longer appear in the default Discovery view (which shows `pipeline_stage = 'discovered'`)

**Verify:**
```bash
cd client && npx tsc --noEmit
```

**Done when:**
- "Move to Enrichment" button visible in batch toolbar when sites selected
- Clicking it calls the API and updates pipeline_stage
- Discovery table refreshes and moved sites disappear from view
- API methods for enrichment operations available in api.ts

---

### Task 2: Filter Discovery table to exclude enrichment-stage sites

**Files:** `server/src/routes/sites.ts`, `server/src/db/queries/sites.ts`

**Action:**

In the `listSites` query and the sites list API route:
- Add a `pipeline_stage` filter parameter
- The Discovery page should pass `pipeline_stage=discovered` by default so enrichment-stage sites don't show
- The Enrichment page will use a different endpoint (`/api/enrichment/sites`) to list its sites

In `server/src/routes/sites.ts`:
- Add handler for `POST /api/sites/move-to-enrichment`:
  - Body: `{ siteIds: number[] }`
  - Validates siteIds array not empty
  - Updates each site's `pipeline_stage` to `'enrichment'` and `enrichment_status` to `'pending'`
  - Returns count of updated sites

In `server/src/db/queries/sites.ts`:
- Add `updatePipelineStage(siteIds: number[], stage: string)` function
- Add `updateEnrichmentStatus(siteIds: number[], status: string)` function

**Verify:**
```bash
cd server && npx tsc --noEmit
curl -X POST http://localhost:3001/api/sites/move-to-enrichment -H "Content-Type: application/json" -d '{"siteIds":[1]}'
```

**Done when:**
- Sites can be moved to enrichment via API
- Discovery table only shows `discovered` stage sites by default
- `pipeline_stage` and `enrichment_status` update correctly
- No duplicate moves (moving already-enrichment site is a no-op)

---

### Task 3: Update shared types for enrichment pipeline

**Files:** `shared/types.ts`

**Action:**

Ensure these types exist (may overlap with Plan 1 Task 1 — coordinate):
- `PipelineStage` type: `'discovered' | 'enrichment' | 'enriched' | 'analyzed' | 'reported' | 'outreach'`
- `EnrichmentStatus` type: `'pending' | 'enriching' | 'enriched' | 'error'`
- Add `enrichment_status` to `Site` interface
- Add `SiteFilterParams.pipeline_stage` filter option

**Verify:**
```bash
cd server && npx tsc --noEmit
cd client && npx tsc --noEmit
```

**Done when:**
- All enrichment-related types defined in shared package
- Both server and client compile with new types

---

## Verification

After all tasks complete:

```bash
cd server && npx tsc --noEmit
cd client && npx tsc --noEmit
```

## Success Criteria

- [ ] "Move to Enrichment" button in Discovery batch toolbar
- [ ] Sites move from `discovered` → `enrichment` pipeline stage
- [ ] Discovery table filters out enrichment-stage sites
- [ ] API endpoint for moving sites works correctly
- [ ] Client API methods for all enrichment operations ready
- [ ] Shared types updated for pipeline stages and enrichment status

## Output

**Files modified:**
- `client/src/components/discovery/SiteResultsTable.tsx` — Add Move to Enrichment button
- `client/src/lib/api.ts` — Add enrichment API methods
- `server/src/routes/sites.ts` — Add move-to-enrichment endpoint
- `server/src/db/queries/sites.ts` — Add pipeline stage update functions
- `shared/types.ts` — Add PipelineStage, EnrichmentStatus types
